import{ab as Q,r as N,j as e,aJ as U,C as I,e as V,f as X,g as $,B as Z,n as v,aK as ee,aL as se,aM as te}from"./index-DcTsfPOQ.js";import{T as ae,a as re,b as B,c as E,d as oe,e as M}from"./table-BJW1dPs9.js";import{S as C}from"./skeleton-C0wj_6h9.js";import{L as ne}from"./label-CAQongzc.js";import{d as le,D as de}from"./index-D2zfLPLw.js";import{a as O}from"./api-DUHMZ36Z.js";import{g as P}from"./getDaysInMonth-8Efe35wA.js";import"./index-DcfIKM1A.js";function _(a){return Q(a).getDay()}const ie=(a,j)=>{const c=_(a);return j[{0:"sunday",1:"monday",2:"tuesday",3:"wednesday",4:"thursday",5:"friday",6:"saturday"}[c]]===!0},z=a=>[a.monday,a.tuesday,a.wednesday,a.thursday,a.friday,a.saturday,a.sunday].filter(Boolean).length*8,ce=(a,j)=>{const c=_(a),y=z(j);if(y===40){if(c===5||c===6)return"Holiday"}else if(y===48&&c===5)return"Holiday";return""},be=()=>{const[a,j]=N.useState(new Date),[c,y]=N.useState(!1);N.useState(!1);const[w,R]=N.useState([]),[F,T]=N.useState({});N.useEffect(()=>{Y()},[a]);const Y=async()=>{try{y(!0);const n=await O.list("shiftemployees"),x=await O.list("shift_new"),f=new Map;x.data.forEach(r=>{f.set(r.ShiftID,r)});const g=n.data.map(r=>({...r,employeeName:`${r.employees_FirstName||""} ${r.employees_LastName||""}`.trim(),shift:f.get(r.ShiftID)}));R(g)}catch(n){console.error("Error fetching shift employees:",n)}finally{y(!1)}},G=async()=>{var n;if(w.length){y(!0);try{const x=a.getFullYear(),f=a.getMonth(),g=P(a),r=new Date(x,f,1),l=new Date(x,f+1,0),o=await O.list("timeattendancebook",{sort:"asc",pageSize:1e3,select_fields:["TimeAttendanceBookID","EmployeeID","AttendanceDate","TotalHoursWorked","OvertimeHours","AbsentHours","DelayHours","LeaveHours","Status","Notes","IsProcessed"].join(","),advanced_filters:[{column:"AttendanceDate",filter_type:"greater_equals",value:v(r,"yyyy-MM-dd")},{column:"AttendanceDate",filter_type:"less_equals",value:v(l,"yyyy-MM-dd")}]}),p={};o.data.forEach(t=>{p[t.EmployeeID]||(p[t.EmployeeID]={});const m=v(new Date(t.AttendanceDate),"yyyy-MM-dd");p[t.EmployeeID][m]=t});const u={};for(const t of w){if(!t.shift)continue;const m=t.EmployeeID,L=t.employeeName||`${t.employees_FirstName} ${t.employees_LastName}`,{shift:k}=t;u[m]=[];for(let D=1;D<=g;D++){const b=new Date(x,f,D),S=v(b,"yyyy-MM-dd"),s=(n=p[m])==null?void 0:n[S],d=ie(b,k),A=ce(b,k);if(s){let i=s.Status||"Present",h=0,W=0,J=s.OvertimeHours||0,H=s.TotalHoursWorked||0;h=s.DelayHours||0,d&&H>0&&H<8&&!h&&(h=8-H),h>0&&(i="Late"),d&&H===0&&(W=8,i="Absent"),u[m].push({EmployeeID:m,AttendanceDate:b,TotalHoursWorked:H,OvertimeHours:J,Status:i,Notes:s.Notes,AbsentHours:W,DelayHours:h,LeaveHours:0,employeeName:`${t.employees_FirstName} ${t.employees_LastName}`,employees_FirstName:t.employees_FirstName,employees_LastName:t.employees_LastName})}else{let i,h=0;A?i="Day Off":(i="Absent",h=8),u[m].push({EmployeeID:m,AttendanceDate:b,TotalHoursWorked:0,OvertimeHours:0,Status:i,Notes:null,AbsentHours:h,DelayHours:0,LeaveHours:i==="Holiday"?8:0,employeeName:`${t.employees_FirstName} ${t.employees_LastName}`,employees_FirstName:t.employees_FirstName,employees_LastName:t.employees_LastName})}}}T(u)}catch(x){console.error("Error generating attendance book:",x)}finally{y(!1)}}},K=n=>{n&&(j(n.toDate()),T({}))},q=()=>{if(c)return e.jsxs("div",{className:"space-y-4",children:[e.jsx(C,{className:"h-10 w-full"}),e.jsx("div",{className:"space-y-2",children:Array(10).fill(0).map((r,l)=>e.jsx(C,{className:"h-12 w-full"},l))})]});if(w.length===0)return e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"No employees found. Please assign employees to shifts first."});const n=P(a),x=a.getFullYear(),f=a.getMonth(),g=Object.keys(F).map(Number);return g.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:'No attendance data available. Click "Generate Report" to generate the attendance book.'}):e.jsx("div",{className:"rounded-md border w-full overflow-x-auto max-h-[70vh]",children:e.jsxs(ae,{children:[e.jsx(re,{className:"sticky top-0 bg-background z-10",children:e.jsxs(B,{children:[e.jsx(E,{className:"sticky left-0 z-20 bg-background border-r min-w-[180px]",children:"Employee"}),Array.from({length:n},(r,l)=>{const o=new Date(x,f,l+1),p=v(o,"EEE"),u=_(o),t=u===0||u===6;return e.jsx(E,{className:`sticky top-0 z-10 bg-background border min-w-[65px] max-w-[65px] p-1 text-center ${t?"text-destructive":""}`,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-xs",children:l+1}),e.jsx("span",{className:"text-[0.7rem] opacity-70",children:p})]})},`day-${l}`)}),e.jsx(E,{className:"sticky top-0 right-0 z-10 bg-background border-l min-w-[120px]",children:"Summary"})]})}),e.jsx(oe,{children:g.map(r=>{const l=w.find(s=>s.EmployeeID===r);if(!l)return null;const o=F[r],p=o.filter(s=>s.Status==="Present").length,u=o.filter(s=>s.Status==="Late").length,t=o.filter(s=>s.Status==="Absent").length,m=o.filter(s=>s.Status==="Holiday").length,L=o.filter(s=>s.Status==="DayOff"||s.Status==="Day Off").length,k=o.reduce((s,d)=>s+(d.TotalHoursWorked||0),0),D=o.reduce((s,d)=>s+(d.OvertimeHours||0),0),b=o.reduce((s,d)=>s+(d.DelayHours||0),0),S=o.reduce((s,d)=>s+(d.AbsentHours||0),0);return e.jsxs(B,{className:"hover:bg-muted/50",children:[e.jsxs(M,{className:"sticky left-0 z-10 bg-background border-r min-w-[180px]",children:[e.jsx("div",{className:"font-medium",children:l.employeeName}),e.jsx("div",{className:"text-xs text-muted-foreground",children:l.shift?`Shift: ${l.shift.ShiftID} (${z(l.shift)}h/week)`:"No shift"})]}),o.map((s,d)=>{const A={Present:"bg-green-50 border-green-200 hover:bg-green-100",Late:"bg-yellow-50 border-yellow-200 hover:bg-yellow-100",Absent:"bg-red-50 border-red-200 hover:bg-red-100",Holiday:"bg-blue-50 border-blue-200 hover:bg-blue-100",DayOff:"bg-gray-50 border-gray-100","Day Off":"bg-gray-50 border-gray-100"}[s.Status]||"bg-background",i=s.Status==="Present"||s.Status==="Late"||s.Status==="Absent";return e.jsxs(ee,{children:[e.jsx(se,{asChild:!0,children:e.jsx(M,{className:`p-1 min-w-[65px] max-w-[65px] text-center border ${A} cursor-pointer`,children:e.jsxs("div",{className:"flex flex-col items-center text-xs",children:[s.Status==="Holiday"&&e.jsx("div",{className:"text-blue-600 font-medium",children:"H"}),(s.Status==="DayOff"||s.Status==="Day Off")&&e.jsx("div",{className:"text-gray-500",children:"OFF"}),s.Status==="Absent"&&e.jsx("div",{className:"text-red-600 font-medium",children:"ABS"}),i&&s.TotalHoursWorked>0&&e.jsx("div",{className:"font-medium",children:s.TotalHoursWorked.toFixed(1)}),s.OvertimeHours>0&&e.jsxs("div",{className:"text-green-600",children:["+",s.OvertimeHours.toFixed(1)]}),s.DelayHours>0&&e.jsxs("div",{className:"text-orange-600",children:["-",s.DelayHours.toFixed(1)]})]})})}),e.jsx(te,{className:"max-w-[250px] p-3",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"font-semibold",children:v(s.AttendanceDate,"EEEE, MMMM d, yyyy")}),e.jsxs("p",{children:[e.jsx("strong",{children:"Status:"})," ",s.Status]}),s.Notes&&e.jsxs("p",{children:[e.jsx("strong",{children:"Note:"})," ",s.Notes]}),i&&e.jsxs("div",{className:"pt-2 mt-2 border-t border-border",children:[e.jsxs("p",{children:["Hours Worked: ",s.TotalHoursWorked.toFixed(2)]}),s.DelayHours>0&&e.jsxs("p",{children:["Delay Hours: ",s.DelayHours.toFixed(2)]}),s.OvertimeHours>0&&e.jsxs("p",{children:["Overtime: ",s.OvertimeHours.toFixed(2)]}),s.AbsentHours>0&&e.jsxs("p",{children:["Absent Hours: ",s.AbsentHours.toFixed(2)]})]})]})})]},`day-${d}`)}),e.jsx(M,{className:"sticky right-0 z-10 bg-background border-l min-w-[120px]",children:e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Worked:"}),e.jsxs("span",{className:"font-medium",children:[k.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Overtime:"}),e.jsxs("span",{className:"text-green-600",children:["+",D.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Delay:"}),e.jsxs("span",{className:"text-orange-600",children:["-",b.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Absent:"}),e.jsxs("span",{className:"text-red-600",children:["-",S.toFixed(1),"h"]})]}),e.jsx("div",{className:"h-px bg-border my-1"}),e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{children:"Present:"}),e.jsxs("span",{className:"text-green-600",children:[p,"d"]})]}),e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{children:"Late:"}),e.jsxs("span",{className:"text-orange-600",children:[u,"d"]})]}),e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{children:"Absent:"}),e.jsxs("span",{className:"text-red-600",children:[t,"d"]})]}),e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{children:"Holiday:"}),e.jsxs("span",{className:"text-blue-600",children:[m,"d"]})]}),e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{children:"Day Off:"}),e.jsxs("span",{className:"text-gray-500",children:[L,"d"]})]})]})})]},`emp-${r}`)})})]})})};return e.jsx(U,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs(I,{children:[e.jsx(V,{children:e.jsx(X,{children:"Time Attendance Book"})}),e.jsxs($,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-end mb-6",children:[e.jsxs("div",{className:"grid w-full max-w-sm items-center gap-1.5",children:[e.jsx(ne,{children:"Select Month"}),(()=>{const n=de;return e.jsx(n,{picker:"month",value:le(a),onChange:K,format:"MMMM YYYY",className:"h-10 w-full sm:w-48 border rounded-md px-3"})})()]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(Z,{onClick:G,disabled:c,variant:"outline",className:"h-10 flex-1 sm:flex-initial",children:c?"Generating...":"Generate Report"})})]}),q()]})]}),e.jsx(I,{className:"mt-4",children:e.jsxs($,{className:"p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Legend"}),e.jsxs("div",{className:"flex flex-wrap gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-green-100 border border-green-300"}),e.jsx("span",{children:"Present"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-yellow-100 border border-yellow-300"}),e.jsx("span",{children:"Late"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-red-100 border border-red-300"}),e.jsx("span",{children:"Absent"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-blue-100 border border-blue-300"}),e.jsx("span",{children:"Holiday"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 rounded bg-gray-50 border border-gray-200"}),e.jsx("span",{children:"Day Off"})]})]}),e.jsxs("div",{className:"mt-4 text-sm text-muted-foreground",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Note:"})," 40-hour shifts have Friday & Saturday as holidays. 48-hour shifts have only Friday as holiday."]}),e.jsx("p",{children:"Working less than 8 hours on a working day counts as delay hours. Missing work on working days counts as absent hours."})]})]})})]})})};export{be as default};
